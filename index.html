<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EdgesOf MediScript - AI-Powered Doctor Module</title>
  <link rel="icon" href="https://nyc3.digitaloceanspaces.com/bhindi-drive/files/cab453ed-7d3e-4dfa-9012-038dbc50c1c5/2025-12-07T15-33-38-867Z-c50befdf-chat-image-1765121618851-0.jpg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #f9fafb; }
    .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; transition: all 0.3s; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; border: none; font-size: 14px; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-xs { padding: 4px 8px; font-size: 11px; }
    .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; }
    .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .btn-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
    .btn-secondary { background: white; color: #1f2937; border: 2px solid #e5e7eb; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .stat-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.3s; cursor: pointer; }
    .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .form-input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; }
    .form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px; }
    .badge { display: inline-flex; padding: 4px 10px; border-radius: 16px; font-size: 11px; font-weight: 600; }
    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-purple { background: #ede9fe; color: #6b21a8; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 20px; padding: 32px; max-width: 1200px; max-height: 90vh; overflow-y: auto; width: 90%; margin: 20px; }
    .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-radius: 10px; color: rgba(255,255,255,0.8); transition: all 0.2s; cursor: pointer; }
    .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-link.active { background: rgba(255,255,255,0.15); color: white; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 13px; }
    th { background: #f9fafb; font-weight: 600; }
    .ai-badge { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .ai-result { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border: 2px solid #8b5cf6; border-radius: 12px; padding: 16px; margin: 16px 0; }
    .ai-loading { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    .wizard-step { display: none; }
    .wizard-step.active { display: block; }
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 30px; }
    .step-item { flex: 1; text-align: center; position: relative; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; font-size: 14px; }
    .step-item.active .step-circle { background: #2563eb; color: white; }
    .step-item.completed .step-circle { background: #10b981; color: white; }
    .differential-item { background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .differential-item.critical { border-color: #ef4444; background: #fef2f2; }
    .treatment-day { background: #f9fafb; border-left: 4px solid #8b5cf6; padding: 12px; margin-bottom: 8px; border-radius: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- AI Differential Diagnosis Modal -->
  <div id="aiDifferentialModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-2xl font-bold">üî¨ AI Differential Diagnosis</h2>
          <p class="text-sm text-gray-600 mt-1">Rule out dangerous conditions</p>
        </div>
        <button onclick="closeModal('aiDifferentialModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div class="mb-4">
        <label class="form-label">Symptoms & Findings *</label>
        <textarea id="diffSymptoms" class="form-input" rows="4" placeholder="e.g., Chest pain, radiating to left arm, sweating, shortness of breath"></textarea>
      </div>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><label class="form-label">Age</label><input type="number" id="diffAge" class="form-input" value="45"></div>
        <div><label class="form-label">Gender</label><select id="diffGender" class="form-input"><option>Male</option><option>Female</option></select></div>
        <div><label class="form-label">Duration</label><input type="text" id="diffDuration" class="form-input" placeholder="e.g., 2 hours"></div>
      </div>
      <div id="aiDifferentialResult"></div>
      <div class="flex gap-3">
        <button onclick="getAIDifferential()" class="btn btn-purple" id="aiDifferentialBtn">üî¨ Analyze Differentials</button>
        <button onclick="closeModal('aiDifferentialModal')" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- AI Treatment Planner Modal -->
  <div id="aiTreatmentModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-2xl font-bold">üìã AI Treatment Planner</h2>
          <p class="text-sm text-gray-600 mt-1">Step-by-step treatment protocol</p>
        </div>
        <button onclick="closeModal('aiTreatmentModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div class="mb-4">
        <label class="form-label">Confirmed Diagnosis *</label>
        <input type="text" id="treatDiagnosis" class="form-input" placeholder="e.g., Acute Bronchitis" required>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="form-label">Severity</label><select id="treatSeverity" class="form-input"><option>Mild</option><option>Moderate</option><option>Severe</option></select></div>
        <div><label class="form-label">Comorbidities</label><input type="text" id="treatComorbid" class="form-input" placeholder="e.g., Diabetes, HTN"></div>
      </div>
      <div id="aiTreatmentResult"></div>
      <div class="flex gap-3">
        <button onclick="getAITreatment()" class="btn btn-purple" id="aiTreatmentBtn">üìã Generate Protocol</button>
        <button onclick="closeModal('aiTreatmentModal')" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- AI Follow-up Predictor Modal -->
  <div id="aiFollowupModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-2xl font-bold">üìÖ AI Follow-up Predictor</h2>
          <p class="text-sm text-gray-600 mt-1">Optimal return date prediction</p>
        </div>
        <button onclick="closeModal('aiFollowupModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div class="mb-4">
        <label class="form-label">Diagnosis *</label>
        <input type="text" id="followDiagnosis" class="form-input" placeholder="e.g., Pneumonia" required>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="form-label">Treatment Duration</label><input type="text" id="followTreatment" class="form-input" placeholder="e.g., 7 days antibiotics"></div>
        <div><label class="form-label">Severity</label><select id="followSeverity" class="form-input"><option>Mild</option><option>Moderate</option><option>Severe</option></select></div>
      </div>
      <div class="mb-4">
        <label class="form-label">Special Considerations</label>
        <textarea id="followNotes" class="form-input" rows="2" placeholder="e.g., Elderly patient, lives alone"></textarea>
      </div>
      <div id="aiFollowupResult"></div>
      <div class="flex gap-3">
        <button onclick="getAIFollowup()" class="btn btn-purple" id="aiFollowupBtn">üìÖ Predict Follow-up</button>
        <button onclick="closeModal('aiFollowupModal')" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Clinical Examination Modal (Enhanced) -->
  <div id="examinationModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">ü©∫ Clinical Examination</h2>
        <button onclick="closeModal('examinationModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>

      <form onsubmit="saveExamination(event)">
        <div class="mb-4">
          <label class="form-label">Patient *</label>
          <select id="examPatient" class="form-input" required></select>
        </div>

        <div class="card">
          <h3 class="font-bold mb-4">üìä Vital Signs</h3>
          <div class="grid grid-cols-3 gap-4">
            <div><label class="form-label">BP</label><input type="text" id="vitalBP" class="form-input" placeholder="120/80"></div>
            <div><label class="form-label">Temp</label><input type="text" id="vitalTemp" class="form-input" placeholder="98.6¬∞F"></div>
            <div><label class="form-label">Pulse</label><input type="text" id="vitalPulse" class="form-input" placeholder="72"></div>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label">Chief Complaint *</label>
          <textarea id="examComplaint" class="form-input" rows="2" required></textarea>
        </div>

        <div class="mb-4">
          <label class="form-label">Provisional Diagnosis *</label>
          <input type="text" id="examDiagnosis" class="form-input" required>
          <div class="flex gap-2 mt-2">
            <button type="button" onclick="openModal('aiDifferentialModal')" class="btn btn-purple btn-xs">üî¨ Differential Diagnosis</button>
            <button type="button" onclick="openModal('aiTreatmentModal')" class="btn btn-purple btn-xs">üìã Treatment Plan</button>
            <button type="button" onclick="openModal('aiFollowupModal')" class="btn btn-purple btn-xs">üìÖ Follow-up Date</button>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label">Treatment Plan</label>
          <textarea id="examTreatment" class="form-input" rows="3"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="form-label">Follow-up Date</label><input type="date" id="examFollowup" class="form-input"></div>
          <div><label class="form-label">Follow-up Notes</label><input type="text" id="examFollowupNotes" class="form-input"></div>
        </div>

        <div class="flex gap-3">
          <button type="submit" class="btn btn-success">‚úÖ Save Examination</button>
          <button type="button" onclick="generatePrescriptionPDF()" class="btn btn-primary">üìÑ Generate PDF</button>
          <button type="button" onclick="closeModal('examinationModal')" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Patient Registration Modal (Simplified for space) -->
  <div id="patientModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">üë§ Register Patient</h2>
        <button onclick="closeModal('patientModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <form onsubmit="savePatient(event)">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="form-label">First Name *</label><input type="text" id="patFirstName" class="form-input" required></div>
          <div><label class="form-label">Last Name *</label><input type="text" id="patLastName" class="form-input" required></div>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div><label class="form-label">Age *</label><input type="number" id="patAge" class="form-input" required></div>
          <div><label class="form-label">Gender *</label><select id="patGender" class="form-input"><option>Male</option><option>Female</option></select></div>
          <div><label class="form-label">Blood</label><select id="patBlood" class="form-input"><option>O+</option><option>A+</option><option>B+</option><option>AB+</option></select></div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="form-label">Phone *</label><input type="tel" id="patPhone" class="form-input" required></div>
          <div><label class="form-label">Email</label><input type="email" id="patEmail" class="form-input"></div>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="btn btn-success">‚úÖ Save</button>
          <button type="button" onclick="closeModal('patientModal')" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    const GEMINI_API_KEY = 'AIzaSyCnFkJT7t9FSq_vj1tAlhNifItoBMAzaMc';
    
    let DB = {
      patients: [
        {id: 'p1', patient_id: 'P001', first_name: 'Rajesh', last_name: 'Kumar', age: 45, gender: 'Male', blood_group: 'O+', phone: '+919876543220'},
        {id: 'p2', patient_id: 'P002', first_name: 'Priya', last_name: 'Sharma', age: 32, gender: 'Female', blood_group: 'A+', phone: '+919876543221'},
        {id: 'p3', patient_id: 'P003', first_name: 'Kumar', last_name: 'Vaibhav', age: 28, gender: 'Male', blood_group: 'A-', phone: '09999456126'}
      ],
      examinations: []
    };

    let currentScreen = 'dashboard';

    async function callGemini(prompt) {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
        })
      });
      const data = await response.json();
      return data.candidates[0].content.parts[0].text;
    }

    // AI DIFFERENTIAL DIAGNOSIS
    window.getAIDifferential = async function() {
      const symptoms = document.getElementById('diffSymptoms').value;
      if (!symptoms) { alert('Enter symptoms'); return; }

      const btn = document.getElementById('aiDifferentialBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="ai-loading"></div> Analyzing...';

      try {
        const prompt = `Expert diagnostician. Differential diagnosis for: ${symptoms}
Age: ${document.getElementById('diffAge').value}, Gender: ${document.getElementById('diffGender').value}, Duration: ${document.getElementById('diffDuration').value}

Provide JSON:
{
  "differentials": [
    {
      "diagnosis": "Most likely diagnosis",
      "probability": 70,
      "reasoning": "Why this is likely",
      "criticalFeatures": ["Feature 1", "Feature 2"],
      "isCritical": false
    }
  ],
  "redFlags": ["Red flag 1", "Red flag 2"],
  "emergencyProtocol": "When to call emergency",
  "nextSteps": "Immediate actions needed"
}

Include at least 3 differentials. Mark life-threatening conditions as isCritical: true.`;

        const text = await callGemini(prompt);
        const json = JSON.parse(text.match(/\{[\s\S]*\}/)[0]);
        
        let html = '<div class="ai-result"><h3 class="font-bold text-purple-700 mb-4">üî¨ Differential Diagnosis</h3>';
        
        json.differentials.forEach((d, i) => {
          const criticalClass = d.isCritical ? 'critical' : '';
          html += `<div class="differential-item ${criticalClass}">
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-bold text-lg">${i+1}. ${d.diagnosis}</h4>
              <span class="badge ${d.isCritical ? 'badge-danger' : 'badge-purple'}">${d.probability}%</span>
            </div>
            <p class="text-sm text-gray-700 mb-2">${d.reasoning}</p>
            <p class="text-xs"><strong>Key Features:</strong> ${d.criticalFeatures.join(', ')}</p>
            ${d.isCritical ? '<p class="text-xs text-red-600 mt-2"><strong>‚ö†Ô∏è CRITICAL - Requires immediate attention</strong></p>' : ''}
          </div>`;
        });

        if (json.redFlags && json.redFlags.length > 0) {
          html += `<div class="mt-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
            <strong class="text-red-700">üö® Red Flags:</strong>
            <ul class="text-sm text-red-600 mt-2 list-disc list-inside">
              ${json.redFlags.map(f => `<li>${f}</li>`).join('')}
            </ul>
          </div>`;
        }

        if (json.emergencyProtocol) {
          html += `<div class="mt-3 p-3 bg-orange-50 border-2 border-orange-300 rounded-lg">
            <strong class="text-orange-700">‚ö° Emergency Protocol:</strong>
            <p class="text-sm text-orange-600 mt-1">${json.emergencyProtocol}</p>
          </div>`;
        }

        if (json.nextSteps) {
          html += `<div class="mt-3 p-3 bg-blue-50 rounded-lg">
            <strong class="text-blue-700">üìã Next Steps:</strong>
            <p class="text-sm text-blue-600 mt-1">${json.nextSteps}</p>
          </div>`;
        }

        html += '</div>';
        document.getElementById('aiDifferentialResult').innerHTML = html;
      } catch (e) {
        console.error(e);
        document.getElementById('aiDifferentialResult').innerHTML = '<div class="ai-result text-red-600">Error analyzing. Try again.</div>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üî¨ Analyze Differentials';
      }
    };

    // AI TREATMENT PLANNER
    window.getAITreatment = async function() {
      const diagnosis = document.getElementById('treatDiagnosis').value;
      if (!diagnosis) { alert('Enter diagnosis'); return; }

      const btn = document.getElementById('aiTreatmentBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="ai-loading"></div> Planning...';

      try {
        const prompt = `Treatment protocol expert. Create detailed treatment plan for: ${diagnosis}
Severity: ${document.getElementById('treatSeverity').value}
Comorbidities: ${document.getElementById('treatComorbid').value}

Provide JSON:
{
  "treatmentPlan": {
    "dayByDay": [
      {
        "day": "Day 1-3",
        "medications": ["Med 1 - dosage", "Med 2 - dosage"],
        "instructions": "What to do",
        "monitoring": "What to watch"
      }
    ],
    "lifestyle": ["Lifestyle modification 1", "Lifestyle modification 2"],
    "diet": ["Dietary recommendation 1", "Dietary recommendation 2"],
    "warningSign": ["Warning sign 1", "Warning sign 2"],
    "emergencyCriteria": "When to seek emergency care",
    "expectedOutcome": "What to expect",
    "duration": "Total treatment duration"
  }
}`;

        const text = await callGemini(prompt);
        const json = JSON.parse(text.match(/\{[\s\S]*\}/)[0]);
        const plan = json.treatmentPlan;
        
        let html = '<div class="ai-result"><h3 class="font-bold text-purple-700 mb-4">üìã Treatment Protocol</h3>';
        
        html += '<div class="mb-4"><h4 class="font-bold mb-2">üìÖ Day-by-Day Plan:</h4>';
        plan.dayByDay.forEach(day => {
          html += `<div class="treatment-day">
            <h5 class="font-bold text-purple-700">${day.day}</h5>
            <p class="text-sm mt-1"><strong>Medications:</strong></p>
            <ul class="text-sm list-disc list-inside ml-2">
              ${day.medications.map(m => `<li>${m}</li>`).join('')}
            </ul>
            <p class="text-sm mt-2"><strong>Instructions:</strong> ${day.instructions}</p>
            <p class="text-sm mt-1"><strong>Monitor:</strong> ${day.monitoring}</p>
          </div>`;
        });
        html += '</div>';

        html += `<div class="grid grid-cols-2 gap-4 mb-4">
          <div class="p-3 bg-green-50 rounded-lg">
            <strong class="text-green-700">ü•ó Diet:</strong>
            <ul class="text-sm text-green-600 mt-1 list-disc list-inside">
              ${plan.diet.map(d => `<li>${d}</li>`).join('')}
            </ul>
          </div>
          <div class="p-3 bg-blue-50 rounded-lg">
            <strong class="text-blue-700">üèÉ Lifestyle:</strong>
            <ul class="text-sm text-blue-600 mt-1 list-disc list-inside">
              ${plan.lifestyle.map(l => `<li>${l}</li>`).join('')}
            </ul>
          </div>
        </div>`;

        html += `<div class="p-3 bg-yellow-50 border-2 border-yellow-300 rounded-lg mb-3">
          <strong class="text-yellow-700">‚ö†Ô∏è Warning Signs:</strong>
          <ul class="text-sm text-yellow-600 mt-1 list-disc list-inside">
            ${plan.warningSign.map(w => `<li>${w}</li>`).join('')}
          </ul>
        </div>`;

        html += `<div class="p-3 bg-red-50 border-2 border-red-300 rounded-lg mb-3">
          <strong class="text-red-700">üö® Seek Emergency Care If:</strong>
          <p class="text-sm text-red-600 mt-1">${plan.emergencyCriteria}</p>
        </div>`;

        html += `<div class="p-3 bg-purple-50 rounded-lg">
          <p class="text-sm"><strong>Expected Outcome:</strong> ${plan.expectedOutcome}</p>
          <p class="text-sm mt-1"><strong>Duration:</strong> ${plan.duration}</p>
        </div>`;

        html += '<button onclick="copyTreatmentToForm()" class="btn btn-primary btn-sm mt-3">üìã Copy to Treatment Plan</button>';
        html += '</div>';
        
        document.getElementById('aiTreatmentResult').innerHTML = html;
        window.currentTreatmentPlan = plan;
      } catch (e) {
        console.error(e);
        document.getElementById('aiTreatmentResult').innerHTML = '<div class="ai-result text-red-600">Error generating plan. Try again.</div>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üìã Generate Protocol';
      }
    };

    window.copyTreatmentToForm = function() {
      const plan = window.currentTreatmentPlan;
      let text = 'TREATMENT PLAN:\n\n';
      plan.dayByDay.forEach(day => {
        text += `${day.day}:\n`;
        day.medications.forEach(m => text += `- ${m}\n`);
        text += `Instructions: ${day.instructions}\n\n`;
      });
      text += '\nLIFESTYLE:\n' + plan.lifestyle.join('\n');
      text += '\n\nDIET:\n' + plan.diet.join('\n');
      document.getElementById('examTreatment').value = text;
      closeModal('aiTreatmentModal');
      alert('‚úÖ Treatment plan copied to form!');
    };

    // AI FOLLOW-UP PREDICTOR
    window.getAIFollowup = async function() {
      const diagnosis = document.getElementById('followDiagnosis').value;
      if (!diagnosis) { alert('Enter diagnosis'); return; }

      const btn = document.getElementById('aiFollowupBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="ai-loading"></div> Predicting...';

      try {
        const prompt = `Follow-up scheduling expert. Predict optimal follow-up for: ${diagnosis}
Treatment: ${document.getElementById('followTreatment').value}
Severity: ${document.getElementById('followSeverity').value}
Notes: ${document.getElementById('followNotes').value}

Provide JSON:
{
  "followup": {
    "recommendedDays": 7,
    "recommendedDate": "Calculate from today",
    "reasoning": "Why this timing",
    "criticalCheckpoints": ["Checkpoint 1", "Checkpoint 2"],
    "alternativeSchedule": "If patient can't make it",
    "urgentFollowupIf": ["Condition 1", "Condition 2"],
    "whatToMonitor": ["Monitor 1", "Monitor 2"]
  }
}`;

        const text = await callGemini(prompt);
        const json = JSON.parse(text.match(/\{[\s\S]*\}/)[0]);
        const followup = json.followup;
        
        const followupDate = new Date();
        followupDate.setDate(followupDate.getDate() + followup.recommendedDays);
        const dateStr = followupDate.toISOString().split('T')[0];
        
        let html = '<div class="ai-result"><h3 class="font-bold text-purple-700 mb-4">üìÖ Follow-up Prediction</h3>';
        
        html += `<div class="p-4 bg-purple-50 border-2 border-purple-300 rounded-lg mb-4">
          <div class="text-center">
            <p class="text-sm text-purple-600">Recommended Follow-up</p>
            <p class="text-3xl font-bold text-purple-700 my-2">${followup.recommendedDays} Days</p>
            <p class="text-lg font-semibold text-purple-600">${dateStr}</p>
          </div>
        </div>`;

        html += `<div class="p-3 bg-blue-50 rounded-lg mb-3">
          <strong class="text-blue-700">üí° Reasoning:</strong>
          <p class="text-sm text-blue-600 mt-1">${followup.reasoning}</p>
        </div>`;

        html += `<div class="p-3 bg-green-50 rounded-lg mb-3">
          <strong class="text-green-700">‚úÖ Critical Checkpoints:</strong>
          <ul class="text-sm text-green-600 mt-1 list-disc list-inside">
            ${followup.criticalCheckpoints.map(c => `<li>${c}</li>`).join('')}
          </ul>
        </div>`;

        html += `<div class="p-3 bg-yellow-50 rounded-lg mb-3">
          <strong class="text-yellow-700">üìä What to Monitor:</strong>
          <ul class="text-sm text-yellow-600 mt-1 list-disc list-inside">
            ${followup.whatToMonitor.map(m => `<li>${m}</li>`).join('')}
          </ul>
        </div>`;

        html += `<div class="p-3 bg-red-50 border-2 border-red-300 rounded-lg mb-3">
          <strong class="text-red-700">üö® Urgent Follow-up If:</strong>
          <ul class="text-sm text-red-600 mt-1 list-disc list-inside">
            ${followup.urgentFollowupIf.map(u => `<li>${u}</li>`).join('')}
          </ul>
        </div>`;

        html += `<div class="p-3 bg-gray-50 rounded-lg">
          <strong>Alternative Schedule:</strong>
          <p class="text-sm text-gray-600 mt-1">${followup.alternativeSchedule}</p>
        </div>`;

        html += `<button onclick="setFollowupDate('${dateStr}')" class="btn btn-primary btn-sm mt-3">üìÖ Set Follow-up Date</button>`;
        html += '</div>';
        
        document.getElementById('aiFollowupResult').innerHTML = html;
      } catch (e) {
        console.error(e);
        document.getElementById('aiFollowupResult').innerHTML = '<div class="ai-result text-red-600">Error predicting. Try again.</div>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üìÖ Predict Follow-up';
      }
    };

    window.setFollowupDate = function(date) {
      document.getElementById('examFollowup').value = date;
      closeModal('aiFollowupModal');
      alert('‚úÖ Follow-up date set!');
    };

    // Save Patient
    window.savePatient = function(e) {
      e.preventDefault();
      const p = {
        id: 'p' + Date.now(),
        patient_id: 'P' + String(DB.patients.length + 1).padStart(3, '0'),
        first_name: document.getElementById('patFirstName').value,
        last_name: document.getElementById('patLastName').value,
        age: parseInt(document.getElementById('patAge').value),
        gender: document.getElementById('patGender').value,
        blood_group: document.getElementById('patBlood').value,
        phone: document.getElementById('patPhone').value,
        email: document.getElementById('patEmail').value
      };
      DB.patients.push(p);
      closeModal('patientModal');
      alert('‚úÖ Patient saved!');
      render();
    };

    // Save Examination
    window.saveExamination = function(e) {
      e.preventDefault();
      const exam = {
        id: 'e' + Date.now(),
        patient_id: document.getElementById('examPatient').value,
        date: new Date().toISOString().split('T')[0],
        vitals: {
          bp: document.getElementById('vitalBP').value,
          temp: document.getElementById('vitalTemp').value,
          pulse: document.getElementById('vitalPulse').value
        },
        chief_complaint: document.getElementById('examComplaint').value,
        diagnosis: document.getElementById('examDiagnosis').value,
        treatment_plan: document.getElementById('examTreatment').value,
        followup_date: document.getElementById('examFollowup').value,
        followup_notes: document.getElementById('examFollowupNotes').value
      };
      
      DB.examinations.push(exam);
      closeModal('examinationModal');
      alert('‚úÖ Examination saved!');
      render();
    };

    // Generate PDF
    window.generatePrescriptionPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const patientId = document.getElementById('examPatient').value;
      const patient = DB.patients.find(p => p.id === patientId);
      
      if (!patient) { alert('Select patient first'); return; }

      doc.setFillColor(37, 99, 235);
      doc.rect(0, 0, 210, 40, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(24);
      doc.setFont(undefined, 'bold');
      doc.text('City Health Clinic', 105, 15, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text('Dr. Rajesh Sharma, MBBS, MD | Reg: MCI-12345', 105, 28, { align: 'center' });

      doc.setTextColor(0, 0, 0);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('PRESCRIPTION', 105, 50, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 60);
      doc.text(`Patient: ${patient.first_name} ${patient.last_name}`, 20, 68);
      doc.text(`Age/Gender: ${patient.age}Y / ${patient.gender}`, 20, 75);

      doc.setFont(undefined, 'bold');
      doc.text('Diagnosis:', 20, 90);
      doc.setFont(undefined, 'normal');
      doc.text(document.getElementById('examDiagnosis').value, 20, 97);

      doc.setFont(undefined, 'bold');
      doc.text('Treatment:', 20, 110);
      doc.setFont(undefined, 'normal');
      const treatment = doc.splitTextToSize(document.getElementById('examTreatment').value, 170);
      doc.text(treatment, 20, 117);

      doc.save(`Rx_${patient.patient_id}_${new Date().toISOString().split('T')[0]}.pdf`);
      alert('‚úÖ PDF generated!');
    };

    window.openModal = function(id) {
      document.getElementById(id).classList.add('active');
      if (id === 'examinationModal') {
        const select = document.getElementById('examPatient');
        select.innerHTML = DB.patients.map(p => `<option value="${p.id}">${p.patient_id} - ${p.first_name} ${p.last_name}</option>`).join('');
      }
    };

    window.closeModal = function(id) {
      document.getElementById(id).classList.remove('active');
    };

    window.switchScreen = function(screen) {
      currentScreen = screen;
      render();
    };

    function render() {
      const app = document.getElementById('app');
      
      const nav = `<nav class="bg-gray-900 text-white p-4 flex justify-between sticky top-0 z-50">
        <div class="flex gap-3 items-center">
          <img src="https://nyc3.digitaloceanspaces.com/bhindi-drive/files/cab453ed-7d3e-4dfa-9012-038dbc50c1c5/2025-12-07T15-33-38-867Z-c50befdf-chat-image-1765121618851-0.jpg" class="h-10">
          <h3 class="font-bold text-sm">City Health Clinic</h3>
          <span class="ai-badge">ü§ñ 7 AI Features</span>
        </div>
        <div class="flex items-center gap-3">
          <p class="font-semibold text-sm">Dr. Rajesh Sharma</p>
        </div>
      </nav>`;

      const sidebar = `<aside class="w-64 bg-gray-800 text-white p-4 min-h-screen">
        <nav class="space-y-2">
          <a onclick="switchScreen('dashboard')" class="nav-link ${currentScreen === 'dashboard' ? 'active' : ''}">üìä Dashboard</a>
          <a onclick="switchScreen('patients')" class="nav-link ${currentScreen === 'patients' ? 'active' : ''}">üë• Patients</a>
          <a onclick="switchScreen('examinations')" class="nav-link ${currentScreen === 'examinations' ? 'active' : ''}">ü©∫ Examinations</a>
          <a onclick="switchScreen('ai')" class="nav-link ${currentScreen === 'ai' ? 'active' : ''}">ü§ñ AI Suite</a>
        </nav>
      </aside>`;

      let content = '';

      if (currentScreen === 'dashboard') {
        content = `<h1 class="text-2xl font-bold mb-6">üë®‚Äç‚öïÔ∏è Doctor Dashboard</h1>
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="stat-card" onclick="switchScreen('patients')"><p class="text-gray-600 text-sm mb-1">Patients</p><p class="text-3xl font-bold text-green-600">${DB.patients.length}</p></div>
            <div class="stat-card" onclick="switchScreen('examinations')"><p class="text-gray-600 text-sm mb-1">Examinations</p><p class="text-3xl font-bold text-blue-600">${DB.examinations.length}</p></div>
            <div class="stat-card" onclick="switchScreen('ai')"><p class="text-gray-600 text-sm mb-1">ü§ñ AI Features</p><p class="text-3xl font-bold text-purple-600">7 Active</p></div>
            <div class="stat-card"><p class="text-gray-600 text-sm mb-1">Phase</p><p class="text-3xl font-bold text-orange-600">2/6</p></div>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div class="card">
              <h3 class="font-bold mb-3">‚ö° Quick Actions</h3>
              <button onclick="openModal('patientModal')" class="btn btn-success w-full mb-2">+ New Patient</button>
              <button onclick="openModal('examinationModal')" class="btn btn-primary w-full">ü©∫ New Exam</button>
            </div>
            <div class="card">
              <h3 class="font-bold mb-3">ü§ñ AI Diagnosis</h3>
              <button onclick="openModal('aiDifferentialModal')" class="btn btn-purple w-full mb-2">üî¨ Differential</button>
              <button onclick="openModal('aiTreatmentModal')" class="btn btn-purple w-full">üìã Treatment</button>
            </div>
            <div class="card">
              <h3 class="font-bold mb-3">ü§ñ AI Planning</h3>
              <button onclick="openModal('aiFollowupModal')" class="btn btn-purple w-full">üìÖ Follow-up</button>
            </div>
          </div>`;
      } else if (currentScreen === 'patients') {
        content = `<h1 class="text-2xl font-bold mb-6">üë• Patients</h1>
          <div class="mb-4"><button onclick="openModal('patientModal')" class="btn btn-success">+ Register</button></div>
          <div class="card">
            <table>
              <thead><tr><th>ID</th><th>Name</th><th>Age/Gender</th><th>Blood</th><th>Phone</th></tr></thead>
              <tbody>${DB.patients.map(p => `<tr><td class="font-semibold">${p.patient_id}</td><td>${p.first_name} ${p.last_name}</td><td>${p.age}Y ${p.gender}</td><td>${p.blood_group}</td><td class="text-xs">${p.phone}</td></tr>`).join('')}</tbody>
            </table>
          </div>`;
      } else if (currentScreen === 'examinations') {
        content = `<h1 class="text-2xl font-bold mb-6">ü©∫ Examinations</h1>
          <div class="mb-4"><button onclick="openModal('examinationModal')" class="btn btn-success">+ New Exam</button></div>
          <div class="card">
            ${DB.examinations.length === 0 ? '<p class="text-gray-500">No examinations yet</p>' : `<table>
              <thead><tr><th>Date</th><th>Patient</th><th>Complaint</th><th>Diagnosis</th><th>Follow-up</th></tr></thead>
              <tbody>${DB.examinations.map(e => {
                const p = DB.patients.find(pt => pt.id === e.patient_id);
                return `<tr><td>${e.date}</td><td>${p.first_name} ${p.last_name}</td><td class="text-xs">${e.chief_complaint}</td><td>${e.diagnosis}</td><td>${e.followup_date || 'None'}</td></tr>`;
              }).join('')}</tbody>
            </table>`}
          </div>`;
      } else if (currentScreen === 'ai') {
        content = `<h1 class="text-2xl font-bold mb-6">ü§ñ Complete AI Suite (7 Features)</h1>
          <div class="grid grid-cols-3 gap-6">
            <div class="card cursor-pointer hover:shadow-xl transition" onclick="openModal('aiDifferentialModal')">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-2xl">üî¨</div>
                <div><h3 class="font-bold">Differential Diagnosis</h3><span class="ai-badge">NEW</span></div>
              </div>
              <p class="text-sm text-gray-600">Rule out dangerous conditions with confidence scores</p>
            </div>
            <div class="card cursor-pointer hover:shadow-xl transition" onclick="openModal('aiTreatmentModal')">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-2xl">üìã</div>
                <div><h3 class="font-bold">Treatment Planner</h3><span class="ai-badge">NEW</span></div>
              </div>
              <p class="text-sm text-gray-600">Step-by-step treatment protocols with day-by-day plans</p>
            </div>
            <div class="card cursor-pointer hover:shadow-xl transition" onclick="openModal('aiFollowupModal')">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-2xl">üìÖ</div>
                <div><h3 class="font-bold">Follow-up Predictor</h3><span class="ai-badge">NEW</span></div>
              </div>
              <p class="text-sm text-gray-600">Predict optimal follow-up dates based on condition</p>
            </div>
          </div>`;
      }

      app.innerHTML = `<div>${nav}<div class="flex">${sidebar}<main class="flex-1 p-6">${content}</main></div></div>`;
    }

    console.log('üöÄ PHASE 2 COMPLETE - 7 AI Features Active!');
    render();
  </script>
</body>
</html>