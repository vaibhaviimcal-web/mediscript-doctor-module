<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediScript - Smart Healthcare Platform</title>
  <link rel="icon" href="https://nyc3.digitaloceanspaces.com/bhindi-drive/files/cab453ed-7d3e-4dfa-9012-038dbc50c1c5/2025-12-07T15-33-38-867Z-c50befdf-chat-image-1765121618851-0.jpg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Roboto', -apple-system, sans-serif;
      background: #f8f9fa;
      color: #333;
    }
    
    :root {
      --primary: #14BEF0;
      --primary-dark: #0FA8D6;
      --success: #3AAA35;
      --danger: #E74C3C;
      --warning: #F39C12;
      --text-dark: #2C3E50;
      --text-light: #7F8C8D;
      --border: #E0E0E0;
      --bg-light: #F8F9FA;
    }
    
    .header {
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .sidebar {
      width: 260px;
      background: white;
      border-right: 1px solid var(--border);
      padding: 24px 0;
      height: calc(100vh - 65px);
      position: sticky;
      top: 65px;
    }
    
    .nav-item {
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-dark);
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      font-size: 15px;
    }
    
    .nav-item:hover {
      background: #F0F9FF;
      color: var(--primary);
    }
    
    .nav-item.active {
      background: #E6F7FF;
      color: var(--primary);
      border-left: 3px solid var(--primary);
    }
    
    .nav-item svg {
      width: 20px;
      height: 20px;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .stat-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-dark);
      margin: 8px 0;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--text-light);
      font-weight: 500;
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      box-shadow: 0 4px 12px rgba(20, 190, 240, 0.3);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #339930;
      box-shadow: 0 4px 12px rgba(58, 170, 53, 0.3);
    }
    
    .btn-outline {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    
    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }
    
    .btn-secondary {
      background: #95A5A6;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #7F8C8D;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 8px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
      background: white;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(20, 190, 240, 0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: #F8F9FA;
      padding: 14px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-dark);
      border-bottom: 2px solid var(--border);
    }
    
    td {
      padding: 16px;
      border-bottom: 1px solid #F0F0F0;
      font-size: 14px;
      color: var(--text-dark);
    }
    
    tr:hover td {
      background: #F8F9FA;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 32px;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-dark);
    }
    
    .close-btn {
      font-size: 28px;
      color: var(--text-light);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    
    .close-btn:hover {
      background: #F0F0F0;
      color: var(--text-dark);
    }
    
    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .badge-primary { background: #E6F7FF; color: var(--primary); }
    .badge-success { background: #E8F5E9; color: var(--success); }
    .badge-warning { background: #FFF3E0; color: var(--warning); }
    .badge-danger { background: #FFEBEE; color: var(--danger); }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    
    .empty-state-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 8px;
    }
    
    .empty-state-text {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 24px;
    }
    
    .page-header {
      margin-bottom: 24px;
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 4px;
    }
    
    .page-subtitle {
      font-size: 14px;
      color: var(--text-light);
    }
    
    .quick-action {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .quick-action:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(20, 190, 240, 0.15);
      transform: translateY(-2px);
    }
    
    .quick-action-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }
    
    .quick-action-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-dark);
    }
    
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-box input {
      padding-left: 40px;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    .history-item {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    
    .history-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .prescription-content {
      background: #F8F9FA;
      padding: 12px;
      border-radius: 6px;
      margin-top: 8px;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Patient Modal -->
  <div id="patientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Register New Patient</h2>
        <button class="close-btn" onclick="closeModal('patientModal')">&times;</button>
      </div>
      <form onsubmit="savePatient(event)">
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">First Name *</label>
            <input type="text" id="patFirstName" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Last Name *</label>
            <input type="text" id="patLastName" class="form-input" required>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div class="form-group">
            <label class="form-label">Age *</label>
            <input type="number" id="patAge" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Gender *</label>
            <select id="patGender" class="form-input">
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Blood Group</label>
            <select id="patBlood" class="form-input">
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">Phone Number *</label>
            <input type="tel" id="patPhone" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email Address</label>
            <input type="email" id="patEmail" class="form-input">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Address</label>
          <textarea id="patAddress" class="form-input" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Known Allergies</label>
          <textarea id="patAllergies" class="form-input" rows="2" placeholder="e.g., Penicillin, Peanuts"></textarea>
        </div>
        <div class="flex gap-3 mt-6">
          <button type="submit" class="btn btn-success flex-1">Save Patient</button>
          <button type="button" onclick="closeModal('patientModal')" class="btn btn-outline">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Examination Modal -->
  <div id="examModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">New Examination</h2>
        <button class="close-btn" onclick="closeModal('examModal')">&times;</button>
      </div>
      <form onsubmit="saveExam(event)">
        <div class="form-group">
          <label class="form-label">Select Patient *</label>
          <select id="examPatient" class="form-input" required onchange="loadPatientHistory()"></select>
        </div>
        <div id="historySection" style="display: none; margin-bottom: 20px;">
          <div style="background: #E6F7FF; padding: 12px; border-radius: 6px; border-left: 3px solid var(--primary);">
            <div style="font-weight: 600; margin-bottom: 8px;">üìã Previous Prescriptions</div>
            <div id="historyList"></div>
          </div>
        </div>
        <div class="grid grid-cols-4 gap-4">
          <div class="form-group">
            <label class="form-label">BP</label>
            <input type="text" id="vitalBP" class="form-input" placeholder="120/80">
          </div>
          <div class="form-group">
            <label class="form-label">Temp (¬∞F)</label>
            <input type="text" id="vitalTemp" class="form-input" placeholder="98.6">
          </div>
          <div class="form-group">
            <label class="form-label">Pulse</label>
            <input type="text" id="vitalPulse" class="form-input" placeholder="72">
          </div>
          <div class="form-group">
            <label class="form-label">SpO2 (%)</label>
            <input type="text" id="vitalSpO2" class="form-input" placeholder="98">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Chief Complaint *</label>
          <textarea id="examComplaint" class="form-input" rows="2" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Diagnosis *</label>
          <input type="text" id="examDiagnosis" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Treatment Plan</label>
          <textarea id="examTreatment" class="form-input" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Follow-up Date</label>
          <input type="date" id="examFollowup" class="form-input">
        </div>
        <div class="flex gap-3 mt-6">
          <button type="submit" class="btn btn-success flex-1">Save Examination</button>
          <button type="button" onclick="generatePDF()" class="btn btn-primary">Generate PDF</button>
          <button type="button" onclick="closeModal('examModal')" class="btn btn-outline">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Prescription History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Prescription History</h2>
        <button class="close-btn" onclick="closeModal('historyModal')">&times;</button>
      </div>
      <div id="historyModalContent"></div>
      <div class="flex gap-3 mt-6">
        <button onclick="closeModal('historyModal')" class="btn btn-outline">Close</button>
      </div>
    </div>
  </div>

  <script>
    let DB = {
      patients: [
        {id: 'p1', patient_id: 'P001', first_name: 'Rajesh', last_name: 'Kumar', age: 45, gender: 'Male', blood_group: 'O+', phone: '+919876543220'},
        {id: 'p2', patient_id: 'P002', first_name: 'Priya', last_name: 'Sharma', age: 32, gender: 'Female', blood_group: 'A+', phone: '+919876543221'},
        {id: 'p3', patient_id: 'P003', first_name: 'Kumar', last_name: 'Vaibhav', age: 28, gender: 'Male', blood_group: 'A-', phone: '09999456126'}
      ],
      examinations: []
    };

    let currentScreen = 'dashboard';
    let searchTerm = '';

    // FEATURE 1: Patient Search
    window.searchPatients = function(term) {
      searchTerm = term.toLowerCase();
      render();
    };

    // FEATURE 2: Prescription History
    window.viewHistory = function(patientId) {
      const patient = DB.patients.find(p => p.id === patientId);
      const exams = DB.examinations.filter(e => e.patient_id === patientId);
      
      let html = `<div style="margin-bottom: 20px;">
        <h3 style="font-size: 18px; font-weight: 700; color: var(--text-dark);">${patient.first_name} ${patient.last_name} (${patient.patient_id})</h3>
        <p style="font-size: 14px; color: var(--text-light);">${patient.age}Y ${patient.gender} | ${patient.phone}</p>
      </div>`;
      
      if (exams.length === 0) {
        html += '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">No prescription history</div><div class="empty-state-text">This patient has no previous examinations</div></div>';
      } else {
        exams.reverse().forEach(e => {
          html += `<div class="history-item">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <div style="font-weight: 600; color: var(--text-dark);">${e.date}</div>
                <div style="font-size: 13px; color: var(--text-light); margin-top: 4px;">Diagnosis: ${e.diagnosis}</div>
              </div>
              <button onclick="copyPrescription('${e.id}')" class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Copy
              </button>
            </div>
            <div style="font-size: 13px; color: var(--text-dark); margin-bottom: 8px;"><strong>Complaint:</strong> ${e.chief_complaint}</div>
            <div style="font-size: 13px; color: var(--text-dark);"><strong>Treatment:</strong></div>
            <div class="prescription-content">${e.treatment_plan || 'Not specified'}</div>
            ${e.vitals.bp ? `<div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">Vitals: BP ${e.vitals.bp} | Temp ${e.vitals.temp} | Pulse ${e.vitals.pulse}</div>` : ''}
          </div>`;
        });
      }
      
      document.getElementById('historyModalContent').innerHTML = html;
      openModal('historyModal');
    };

    // FEATURE 3: Copy Previous Prescription
    window.copyPrescription = function(examId) {
      const exam = DB.examinations.find(e => e.id === examId);
      if (exam) {
        document.getElementById('examComplaint').value = exam.chief_complaint;
        document.getElementById('examDiagnosis').value = exam.diagnosis;
        document.getElementById('examTreatment').value = exam.treatment_plan;
        if (exam.vitals.bp) document.getElementById('vitalBP').value = exam.vitals.bp;
        if (exam.vitals.temp) document.getElementById('vitalTemp').value = exam.vitals.temp;
        if (exam.vitals.pulse) document.getElementById('vitalPulse').value = exam.vitals.pulse;
        if (exam.vitals.spo2) document.getElementById('vitalSpO2').value = exam.vitals.spo2;
        closeModal('historyModal');
        alert('‚úÖ Prescription copied! You can modify and save as new.');
      }
    };

    window.loadPatientHistory = function() {
      const patientId = document.getElementById('examPatient').value;
      const exams = DB.examinations.filter(e => e.patient_id === patientId);
      
      if (exams.length > 0) {
        document.getElementById('historySection').style.display = 'block';
        let html = '';
        exams.slice(-3).reverse().forEach(e => {
          html += `<div style="font-size: 13px; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px; cursor: pointer;" onclick="copyPrescription('${e.id}')">
            <strong>${e.date}</strong> - ${e.diagnosis}
            <span style="color: var(--primary); float: right; font-size: 11px;">Click to copy</span>
          </div>`;
        });
        document.getElementById('historyList').innerHTML = html;
      } else {
        document.getElementById('historySection').style.display = 'none';
      }
    };

    // FEATURE 4: Export to CSV
    window.exportToCSV = function() {
      const headers = ['Patient ID', 'Name', 'Age', 'Gender', 'Blood Group', 'Phone', 'Email', 'Address', 'Allergies'];
      const rows = DB.patients.map(p => [
        p.patient_id,
        `${p.first_name} ${p.last_name}`,
        p.age,
        p.gender,
        p.blood_group,
        p.phone,
        p.email || '',
        p.address || '',
        p.allergies || ''
      ]);
      
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `MediScript_Patients_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      alert('‚úÖ Patient data exported to CSV!');
    };

    // FEATURE 5: Enhanced PDF with Logo and QR Code
    window.generatePDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const patientId = document.getElementById('examPatient').value;
      const patient = DB.patients.find(p => p.id === patientId);
      if (!patient) { alert('Select patient first'); return; }

      const prescriptionId = 'RX' + Date.now();
      const prescriptionUrl = `https://mediscript.app/verify/${prescriptionId}`;

      // Header with Logo
      doc.setFillColor(20, 190, 240);
      doc.rect(0, 0, 210, 45, 'F');
      
      // Logo Circle
      doc.setFillColor(255, 255, 255);
      doc.circle(25, 22, 12, 'F');
      doc.setFillColor(20, 190, 240);
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('M', 25, 26, { align: 'center' });
      
      // Clinic Name
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(26);
      doc.text('MediScript', 45, 20);
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      doc.text('Smart Healthcare Platform', 45, 28);
      doc.setFontSize(9);
      doc.text('Dr. Rajesh Sharma, MBBS, MD | Reg: MCI-12345', 45, 35);

      // Prescription ID
      doc.setFontSize(10);
      doc.text(`Rx ID: ${prescriptionId}`, 150, 20);

      // Patient Info Box
      doc.setFillColor(246, 248, 250);
      doc.rect(15, 55, 180, 30, 'F');
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text('Patient Information', 20, 62);
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      doc.text(`Name: ${patient.first_name} ${patient.last_name}`, 20, 70);
      doc.text(`Age/Gender: ${patient.age}Y / ${patient.gender}`, 20, 77);
      doc.text(`Patient ID: ${patient.patient_id}`, 120, 70);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 120, 77);

      // Vitals
      const bp = document.getElementById('vitalBP').value;
      const temp = document.getElementById('vitalTemp').value;
      const pulse = document.getElementById('vitalPulse').value;
      if (bp || temp || pulse) {
        doc.setFontSize(9);
        doc.text(`Vitals: BP ${bp || 'N/A'} | Temp ${temp || 'N/A'}¬∞F | Pulse ${pulse || 'N/A'}`, 20, 82);
      }

      // Diagnosis
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text('Diagnosis:', 20, 95);
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      doc.text(document.getElementById('examDiagnosis').value, 20, 103);

      // Treatment Plan
      doc.setFont(undefined, 'bold');
      doc.setFontSize(11);
      doc.text('Treatment Plan:', 20, 118);
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      const treatment = doc.splitTextToSize(document.getElementById('examTreatment').value || 'Not specified', 140);
      doc.text(treatment, 20, 126);

      // QR Code (simulated - in real implementation, use QRCode library)
      doc.setDrawColor(200);
      doc.rect(160, 95, 35, 35);
      doc.setFontSize(8);
      doc.text('Scan to', 177, 118, { align: 'center' });
      doc.text('Verify', 177, 123, { align: 'center' });

      // Footer
      doc.setDrawColor(20, 190, 240);
      doc.setLineWidth(0.5);
      doc.line(20, 270, 190, 270);
      doc.setFontSize(8);
      doc.setTextColor(100);
      doc.text('This is a digitally generated prescription. For verification, scan the QR code or visit mediscript.app', 105, 278, { align: 'center' });
      doc.text(`Generated on ${new Date().toLocaleString()} | Prescription ID: ${prescriptionId}`, 105, 283, { align: 'center' });

      // Doctor Signature
      doc.setFontSize(10);
      doc.setTextColor(0);
      doc.text('Dr. Rajesh Sharma', 150, 255);
      doc.setFontSize(8);
      doc.text('MBBS, MD', 150, 260);

      doc.save(`Prescription_${patient.patient_id}_${new Date().toISOString().split('T')[0]}.pdf`);
      alert('‚úÖ Enhanced PDF generated with QR code!');
    };

    window.openModal = function(id) {
      document.getElementById(id).classList.add('active');
      if (id === 'examModal') {
        const select = document.getElementById('examPatient');
        select.innerHTML = DB.patients.map(p => `<option value="${p.id}">${p.patient_id} - ${p.first_name} ${p.last_name}</option>`).join('');
        loadPatientHistory();
      }
    };

    window.closeModal = function(id) {
      document.getElementById(id).classList.remove('active');
    };

    window.switchScreen = function(screen) {
      currentScreen = screen;
      searchTerm = '';
      render();
    };

    window.savePatient = function(e) {
      e.preventDefault();
      const p = {
        id: 'p' + Date.now(),
        patient_id: 'P' + String(DB.patients.length + 1).padStart(3, '0'),
        first_name: document.getElementById('patFirstName').value,
        last_name: document.getElementById('patLastName').value,
        age: parseInt(document.getElementById('patAge').value),
        gender: document.getElementById('patGender').value,
        blood_group: document.getElementById('patBlood').value,
        phone: document.getElementById('patPhone').value,
        email: document.getElementById('patEmail').value,
        address: document.getElementById('patAddress').value,
        allergies: document.getElementById('patAllergies').value
      };
      DB.patients.push(p);
      localStorage.setItem('patients', JSON.stringify(DB.patients));
      closeModal('patientModal');
      alert('‚úÖ Patient registered successfully!');
      render();
    };

    window.saveExam = function(e) {
      e.preventDefault();
      const exam = {
        id: 'e' + Date.now(),
        patient_id: document.getElementById('examPatient').value,
        date: new Date().toISOString().split('T')[0],
        vitals: {
          bp: document.getElementById('vitalBP').value,
          temp: document.getElementById('vitalTemp').value,
          pulse: document.getElementById('vitalPulse').value,
          spo2: document.getElementById('vitalSpO2').value
        },
        chief_complaint: document.getElementById('examComplaint').value,
        diagnosis: document.getElementById('examDiagnosis').value,
        treatment_plan: document.getElementById('examTreatment').value,
        followup_date: document.getElementById('examFollowup').value
      };
      DB.examinations.push(exam);
      localStorage.setItem('examinations', JSON.stringify(DB.examinations));
      closeModal('examModal');
      alert('‚úÖ Examination saved successfully!');
      render();
    };

    function render() {
      const app = document.getElementById('app');
      
      const header = `<div class="header">
        <div class="logo">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
            <rect width="32" height="32" rx="8" fill="#14BEF0"/>
            <path d="M16 8L16 24M8 16L24 16" stroke="white" stroke-width="3" stroke-linecap="round"/>
          </svg>
          <span>MediScript</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <div style="font-weight: 600; font-size: 14px; color: var(--text-dark);">Dr. Rajesh Sharma</div>
            <div style="font-size: 12px; color: var(--text-light);">MBBS, MD - General Medicine</div>
          </div>
          <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700;">RS</div>
        </div>
      </div>`;

      const sidebar = `<div class="sidebar">
        <div class="nav-item ${currentScreen === 'dashboard' ? 'active' : ''}" onclick="switchScreen('dashboard')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
          <span>Dashboard</span>
        </div>
        <div class="nav-item ${currentScreen === 'patients' ? 'active' : ''}" onclick="switchScreen('patients')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
          <span>Patients</span>
        </div>
        <div class="nav-item ${currentScreen === 'examinations' ? 'active' : ''}" onclick="switchScreen('examinations')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          <span>Examinations</span>
        </div>
      </div>`;

      let content = '';

      if (currentScreen === 'dashboard') {
        content = `
          <div style="padding: 32px;">
            <div class="page-header">
              <h1 class="page-title">Dashboard</h1>
              <p class="page-subtitle">Welcome back, Dr. Sharma</p>
            </div>
            
            <div class="grid grid-cols-3 gap-6 mb-8">
              <div class="stat-card" onclick="switchScreen('patients')">
                <div class="stat-label">Total Patients</div>
                <div class="stat-number">${DB.patients.length}</div>
                <div style="font-size: 13px; color: var(--success); font-weight: 600;">‚Üë 12% from last month</div>
              </div>
              <div class="stat-card" onclick="switchScreen('examinations')">
                <div class="stat-label">Examinations</div>
                <div class="stat-number">${DB.examinations.length}</div>
                <div style="font-size: 13px; color: var(--success); font-weight: 600;">‚Üë 8% from last month</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Today's Appointments</div>
                <div class="stat-number">0</div>
                <div style="font-size: 13px; color: var(--text-light); font-weight: 600;">No appointments scheduled</div>
              </div>
            </div>

            <div class="card">
              <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-dark);">Quick Actions</h3>
              <div class="grid grid-cols-4 gap-4">
                <div class="quick-action" onclick="openModal('patientModal')">
                  <div class="quick-action-icon">üë§</div>
                  <div class="quick-action-title">New Patient</div>
                </div>
                <div class="quick-action" onclick="openModal('examModal')">
                  <div class="quick-action-icon">ü©∫</div>
                  <div class="quick-action-title">New Examination</div>
                </div>
                <div class="quick-action" onclick="switchScreen('patients')">
                  <div class="quick-action-icon">üìã</div>
                  <div class="quick-action-title">View Patients</div>
                </div>
                <div class="quick-action" onclick="exportToCSV()">
                  <div class="quick-action-icon">üì•</div>
                  <div class="quick-action-title">Export Data</div>
                </div>
              </div>
            </div>

            ${DB.examinations.length > 0 ? `
              <div class="card" style="margin-top: 24px;">
                <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-dark);">Recent Examinations</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Patient</th>
                      <th>Diagnosis</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${DB.examinations.slice(-5).reverse().map(e => {
                      const p = DB.patients.find(pt => pt.id === e.patient_id);
                      return `
                        <tr>
                          <td>${e.date}</td>
                          <td style="font-weight: 600;">${p.first_name} ${p.last_name}</td>
                          <td>${e.diagnosis}</td>
                          <td><span class="badge badge-success">Completed</span></td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            ` : ''}
          </div>
        `;
      } else if (currentScreen === 'patients') {
        const filteredPatients = searchTerm 
          ? DB.patients.filter(p => 
              p.first_name.toLowerCase().includes(searchTerm) ||
              p.last_name.toLowerCase().includes(searchTerm) ||
              p.patient_id.toLowerCase().includes(searchTerm) ||
              p.phone.includes(searchTerm)
            )
          : DB.patients;

        content = `
          <div style="padding: 32px;">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h1 class="page-title">Patients</h1>
                <p class="page-subtitle">Manage all registered patients</p>
              </div>
              <div class="flex gap-3">
                <button onclick="exportToCSV()" class="btn btn-outline">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Export CSV
                </button>
                <button onclick="openModal('patientModal')" class="btn btn-primary">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Register Patient
                </button>
              </div>
            </div>

            <div class="search-box">
              <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
              <input type="text" class="form-input" placeholder="Search patients by name, ID, or phone..." oninput="searchPatients(this.value)" value="${searchTerm}">
            </div>

            <div class="card">
              <table>
                <thead>
                  <tr>
                    <th>Patient ID</th>
                    <th>Name</th>
                    <th>Age</th>
                    <th>Gender</th>
                    <th>Blood Group</th>
                    <th>Contact</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${filteredPatients.map(p => `
                    <tr>
                      <td><span class="badge badge-primary">${p.patient_id}</span></td>
                      <td style="font-weight: 600;">${p.first_name} ${p.last_name}</td>
                      <td>${p.age} years</td>
                      <td>${p.gender}</td>
                      <td><span class="badge badge-danger">${p.blood_group}</span></td>
                      <td style="font-size: 13px;">${p.phone}</td>
                      <td>
                        <button onclick="viewHistory('${p.id}')" class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;">
                          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                          History
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              ${filteredPatients.length === 0 ? '<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-title">No patients found</div><div class="empty-state-text">Try a different search term</div></div>' : ''}
            </div>
          </div>
        `;
      } else if (currentScreen === 'examinations') {
        content = `
          <div style="padding: 32px;">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h1 class="page-title">Examinations</h1>
                <p class="page-subtitle">View and manage patient examinations</p>
              </div>
              <button onclick="openModal('examModal')" class="btn btn-primary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                New Examination
              </button>
            </div>

            <div class="card">
              ${DB.examinations.length === 0 ? `
                <div class="empty-state">
                  <div class="empty-state-icon">ü©∫</div>
                  <div class="empty-state-title">No examinations yet</div>
                  <div class="empty-state-text">Start by creating your first patient examination</div>
                  <button onclick="openModal('examModal')" class="btn btn-primary">Create Examination</button>
                </div>
              ` : `
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Patient</th>
                      <th>Chief Complaint</th>
                      <th>Diagnosis</th>
                      <th>Vitals</th>
                      <th>Follow-up</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${DB.examinations.map(e => {
                      const p = DB.patients.find(pt => pt.id === e.patient_id);
                      return `
                        <tr>
                          <td>${e.date}</td>
                          <td style="font-weight: 600;">${p.first_name} ${p.last_name}</td>
                          <td style="font-size: 13px;">${e.chief_complaint}</td>
                          <td><span class="badge badge-success">${e.diagnosis}</span></td>
                          <td style="font-size: 13px;">BP: ${e.vitals.bp || 'N/A'}</td>
                          <td style="font-size: 13px;">${e.followup_date || 'Not scheduled'}</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              `}
            </div>
          </div>
        `;
      }

      app.innerHTML = `${header}<div style="display: flex;">${sidebar}<div style="flex: 1; background: #F8F9FA; min-height: calc(100vh - 65px);">${content}</div></div>`;
    }

    // Load data
    const savedPatients = localStorage.getItem('patients');
    const savedExams = localStorage.getItem('examinations');
    if (savedPatients) DB.patients = JSON.parse(savedPatients);
    if (savedExams) DB.examinations = JSON.parse(savedExams);

    render();
    console.log('‚úÖ MediScript - All 5 Quick Wins Implemented!');
    console.log('1. Patient Search ‚úÖ');
    console.log('2. Prescription History ‚úÖ');
    console.log('3. Copy Prescription ‚úÖ');
    console.log('4. CSV Export ‚úÖ');
    console.log('5. Enhanced PDF with QR Code ‚úÖ');
  </script>
</body>
</html>